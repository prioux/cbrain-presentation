<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="css/reveal.css">
  <link rel="stylesheet" href="css/night.css">
  <link rel="stylesheet" href="plugin/highlight/style/monokai-sublime.css">
  <meta charset="utf-8"/>
</head>

<body>
  <div class="reveal">
    <div class="slides">

<section>

  <section id="title">
    <img src="images/cbrain-large_white_alpha.png" class="cbblue">
    <h1>A Quick Tour</h1>
    Pierre Rioux
    <br>
    <span>ACElab Developer Meeting, June 2018</span>
  </section>

<!-- ****************************** -->

  <section id="toc">
    <h2>A presentation in three parts:</h2>
    <ol>
      <li>Quick intro to <strong>Ruby</strong> (14 slides)</li>
      <li>Quick intro to <strong>Rails</strong> (17 slides)</li>
      <li><strong>CBRAIN</strong> as a platform (214 slides)</li>
    </ol>
    <p>
    All of this, prepared for experienced programmers.
  </section>

</section>

<!-- ############################## -->
<!-- ############################## -->
<!-- ############################## -->

<section>

  <section id="ruby1">
    <h1>Ruby</h1>
    <h2>A programming language</h2>
  </section>

<!-- ****************************** -->

  <section id="ruby2">
    <h2>Ruby</h2>
    <ul>
      <li>Fully object-oriented</li>
      <li>Single inheritance</li>
      <li><em>Everything</em> is an object:<br>
        <ul>
          <li>Numbers are objects</li>
          <li>Strings are objects</li>
          <li>Methods are objects</li>
          <li>Classes are objects</li>
          <li>Operators are objects</li>
          <li>Code blocks are objects</li>
          <li>etc</li>
        </ul>
      </li>
      <li>Semicolons ( <i>;</i> ) are optional</li>
      <li>Parenthesis for method args are optional</li>
    </ul>
  </section>

<!-- ****************************** -->

  <section id="ruby3">
    <h2>A few Ruby statements</h2>
    <p>
    <pre class="transp"><code class="ruby" data-trim>
"abcd".size    # returns 4
3.1415.to_s    # returns "3.1415"

class Example
  def self.hello
    puts "I'm a class method"
  end

  def hello
    puts "I'm an instance method"
  end
end

Example.hello    # prints "I'm a class method"
Example.hello()  # same; parens are optional

obj = Example.new
obj.hello        # prints "I'm an instance method"
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="ruby4">
    <h2>Objects are NOT data containers</h2>
    Unlike in, say, JavaScript, objects do not store key/values.
    <p>
    <ul>
      <li>Getters and setter methods need to be created</li>
      <li>Data is stored in <em>instance variables</em></li>
      <li>They look like <strong>@variable_name</strong></li>
    </ul>
    <p>
    <pre class="transp"><code class="ruby" data-trim>
class Example
  def set_name(value)
    @name=value
  end

  def name
    return @name  # the 'return' is optional
  end
end

obj1 = Example.new
obj1.set_name("Saturn V rocket")
obj2 = Example.new()
obj2.set_name "Titanic"
puts obj2.name     # prints 'Titanic'
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="ruby5">
    <h2>Symbols</h2>
    A special data type unique to Ruby are <em>symbols</em>
    <p>
    They look like <strong>:symbolname</strong>
    <p>
    They basically are used as fast replacement for constant strings.
    <p>
    They are NOT strings, but can be transformed into strings.
    <p>
    <pre class="transp"><code class="ruby" data-trim>
myvariable = :hello

obj = SomeClass.new
obj.some_method  "all_ok"
obj.other_method :all_ok

:rockets_are_cool.to_s   # returns "rockets_are_cool"
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="ruby6">
    <h2>Hash and array literals</h2>
    They pretty much look like those in Perl or Python
    <p>
    <pre class="transp"><code class="ruby" data-trim>
mixed_hash  = { "abcd" =&gt; 23, :defg =&gt; "aa", 34 =&gt; 41 }

symbol_hash = { :abcd  =&gt; 23, :defg =&gt; "aa" }

symbol_hash = { abcd:     23, defg:    "aa" } # alternative syntax when keys are all symbols

mixed_array = [ 'abcd', 99, Object.new, { "a" =&gt; 1 }, :yoshi ]  # array of 5 elements
    </code></pre>
   When a hash is the last argument of a method call,<br>
   the <i>{</i> and <i>}</i> are optional
   <p>
    <pre class="transp"><code class="ruby" data-trim>
obj.dostuff(23, "hello", { :name =&gt; "pierre", :age =&gt; 76 })

obj.dostuff(23, "hello",   :name =&gt; "pierre", :age =&gt; 76  ) # 3 arguments, not 4

obj.dostuff 23, "hello", name: "pierre", age: 76
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="ruby7">
    <h2>Method names with <i>?</i> or <i>!</i></h2>
    These two characters can appear only as<br>
    the <em>last</em> character in a method name.
    <p>
    Their use is often esthetic.
    <p>
    <pre class="transp"><code class="ruby" data-trim>
class Something
  def is_alive?
    blah blah
  end

  def validate!(mode = :relax)  # argument has default value
    blah blah
  end
end

a_something.is_alive?

a_something.validate!          # inside, mode is :relax
a_something.validate! :strict  # now it's :strict

x="hello"
x.sub("lo","p")  # returns "help" and doesn't change x
x.sub!("lo","p") # returns "help" and change x to "help"
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="ruby8">
    <h2>Assignment methods with <i>=</i></h2>
    For a more elegant syntax, methods can be invoked as assignment.
    <p>
    <pre class="transp"><code class="ruby" data-trim>

# Method with one argument, invoked in the traditional way

def standard(value)
  do_something_with value
end

obj.standard("hello")

# Method with one argument, invoked as an assignment

def assignment=(value)  # note the '=' is part of the method name!
  do_something_with value
end

obj.assignment = "hello"  # the method is "assignment="; spaces are allowed within!
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="ruby9">
    <h2>Most operators are methods</h2>
    So they can be overriden for your classes
    <p>
    <pre class="transp"><code class="ruby" data-trim>
class Something

  def name=(arg)
    @name=arg
  end

  def +(rightside)
    [ @name , rightside.name ]
  end

end

v1 = Something.new; v1.name = "Marilyn"
v2 = Something.new; v2.name = "Monroe"
v1 + v2         # returns [ "Marylin", "Monroe" ]
v1 + a_user     # returns [ "Marylin", "Robert" ] assuming a_user has a name() method.
    </code></pre>
  <p>
   Many operators can be redefined that way:<br>
   <i>+</i>, <i>-</i>, <i>*</i>, <i>|</i>, <i>&</i>, <i>+=</i>, <i>-=</i>,
   <i>&lt;&lt;</i>, <i>&gt;&gt;</i>, <i>&gt;&gt;=</i>, etc
  </section>

<!-- ****************************** -->

  <section id="ruby10">
    <h2>Code blocks for methods</h2>
    <ul>
      <li><em>All</em> methods can take an <em>optional</em> code block as a final argument</li>
      <li><i>It is one of the essential distinguishing feature of Ruby</i></li>
      <li>Methods are free to ignore the block, or call it multiple times</li>
      <li>Blocks are written with the <strong>do ... end</strong> or <strong>{ ... }</strong> syntax</li>
    </ul>
    <pre class="transp"><code class="ruby" data-trim>
obj.mymethod(arg1,arg2) do
  codeblock1
  codeblock2
end

obj.mymethod(arg1,arg2) {  # same as do .. end
  codeblock1
  codeblock2
}

244.to_s(16) do
  puts "This is never executed"
end  # returns the string "f4" which is 244 in hexadecimal

244.to_s(16) { a = 2 + 3 ; system.reboot }  # returns "f4" again
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="ruby11">
    <h2>Arguments to blocks</h2>
    Blocks can be passed arguments with the <em>|var1,var2...|</em> syntax
    <p>
    <pre class="transp"><code class="ruby" data-trim>
# Prints three lines:
#  Z
#  4
#  +
["Z", "4", "+"].each { |c| puts c } # each() is an Array method for iterating

# Prints three lines:
#  Z0
#  41
#  +2
["Z", "4", "+"].each_with_index do |c,i|
   puts(c + i.to_s)
do
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="ruby12">
    <h2>Blocks are invoked with <em>yield</em></h2>
    <p>
    <pre class="transp"><code class="ruby" data-trim>
class Something
  def invoke_and_save
    @save = yield
  end

  def invoke_with_pi
    yield(3.14)
  end

  def vowels
    yield('a') ; yield('e') ; yield('i') ; yield('o') ; yield('u')
  end
end

obj=Something.new
obj.invoke_and_save { "Hello " + 3.to_s }  # internally, @save is now "Hello 3"
obj.invoke_with_pi { |value| puts "I got " + value.to_s } # prints "I got 3.14"
pi_plus_2 = obj.invoke_with_pi { |value| value + 2 }      # stores  5.14 in pi_plus_2
obj.vowels { |v| puts v }  # block is executed five times
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="ruby13">
    <h2>Methods can save the block for later use</h2>
    <p>
    <pre class="transp"><code class="ruby" data-trim>
class Something
  def saveblock(&block)  # special syntax to associate an argument to the block
    @call_this_later = block
  end

  def invoke_saved_block(argument)
    @call_this_later.call(argument)
  end
end

obj = Something.new
obj.saveblock { |x| puts "The string has " + x.size + " characters" }
obj.invoke_saved_block "hello"  # prints "The string has 5 characters"
obj.saveblock { |x| x.reverse }
obj.invoke_saved_block "hello"  # returns (without printing it) "olleh"
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="ruby14">
    <h2>Intercepting missing methods</h2>
    <p>
    <pre class="transp"><code class="ruby" data-trim>
class Something
  def method_missing(name,*args) # * is the splat operator for varargs
    puts "Eh bud, I got method #{name} but it doesn't exist."
  end
end

obj=Something.new
obj.oh_no!('sorry man')  # prints "Eh bud, I got method oh_no! but it does't exist."
    </code></pre>
    <p>
    This is often use to provide <em>dynamic</em> capabilities to classes.
    <p>
    Methods can be created the first time they are missing, and then the
    following times the method will exist and will respond quickly.
    <pre class="transp"><code class="ruby" data-trim>
# Rails example:
User.find_by_login('prioux')  # there is no such method, but it's created right away
User.find_by_login('mmonroe') # now the method does exist.
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="ruby15">
    <h2>Domain Specific Languages</h2>
    Ruby's syntactic flexibility makes it ideal for elegant <em>DSL</em>s.
    <pre class="transp"><code class="ruby" data-trim>
# This is Ruby code:
This is ruby code

# It's executed as:
This(is(ruby(code())))

# A DSL I made up to describe a SQL table.
# It is Ruby code that assumes the methods
# "table", "column", "type" etc have been defined elsewhere.
table "users" do
  column :id
  column :login do
    type :string
    length 256
  end
  has_many do
    other_table "files"
    remote_key :user_id
  end
end
    </code></pre>
  </section>

</section>

<!-- ############################## -->
<!-- ############################## -->
<!-- ############################## -->

<section>

  <section id="rails1">
    <h1>Rails</h1>
    <h2>A web framework</h2>
  </section>

<!-- ****************************** -->

  <section id="rails2">
    <h2>Rails</h2>
    <ul>
      <li>A framework for creating web applications</li>
      <li>Follows the Model-View-Controller (<em>MVC</em>) architecture</li>
      <li>Database abstraction: <strong>ActiveRecord</strong></li>
      <li>Provides helpers for routing, migrations, views</li>
      <li>Multi-layer middleware with the web server at the top</li>
      <li>Normally (and originally) developed in Ruby (thus, "<em>RoR</em>")</li>
      <li>Immense autoconfiguration and meta-programming core</li>
      <li>"Convention over configuration"</li>
    <ul>
  </section>

</section>

<!-- ############################## -->
<!-- ############################## -->
<!-- ############################## -->

<section>

  <section id="models1">
    <h1>Rails</h1>
    <h2>Models</h2>
  </section>

<!-- ****************************** -->

  <section id="models2">
    <h2>Models: let's start with a DB</h2>
    <pre data-trim>
mysql&gt; select * from authors;
+----+------------+-----------+
| id | first_name | last_name |
+----+------------+-----------+
|  1 | Pierre     | Rioux     |
|  2 | Jane       | Austen    |
|  3 | Samir      | Das       |
+----+------------+-----------+
3 rows in set (0.00 sec)

mysql&gt; select * from books;
+----+--------------------------------+-----------+--------------+
| id | title                          | author_id | published_at |
+----+--------------------------------+-----------+--------------+
|  1 | How to cheat at origami        |         1 | 2018-01-03   |
|  2 | Pride And Potatoes             |         2 | 1798-04-21   |
|  3 | Some sunglasses for Kiki       |         3 | 1995-05-10   |
|  4 | Kiki vs the sunglasses tyrants |         3 | 2005-11-21   |
|  5 | The sunglasses of God          |         3 | 2015-12-04   |
+----+--------------------------------+-----------+--------------+
5 rows in set (0.00 sec)
    </pre>
  </section>

<!-- ****************************** -->

  <section id="models3">
    <h2>Model conventions</h2>
    <ul>
      <li>Primary key is <em>id</em></li>
      <li>Table name is pluralized</li>
      <li><strong>Attributes</strong> (columns) are lowercase simple identifiers</li>
      <li>Model names will be singular of table name (e.g. <em>Author</em>, <em>Book</em>)</li>
      <li>Relation use <strong>othermodel_id</strong> (e.g. <em>author_id</em>)</li>
    </ul>
  </section>

<!-- ****************************** -->

  <section id="models4">
    <h2>Ruby classes for the models</h2>
    <center>
    <div class="cell">
      <small><em>app/models/author.rb</em></small>
      <pre class="transp"><code class="ruby" data-trim>
class Author &lt; ApplicationRecord

end
      </code></pre>
    </div>
    <div class="cell">
    &nbsp; &nbsp; &nbsp;
    </div>
    <div class="cell">
      <small><em>app/models/book.rb</em></small>
      <pre class="transp"><code class="ruby" data-trim>
class Book &lt; ApplicationRecord

end
      </code></pre>
    </div>
    </center>
    <p>
    These files are shown complete!
  </section>

<!-- ****************************** -->

  <section id="models5">
    <h2>Model methods</h2>
    <pre class="transp"><code class="ruby" data-trim>
# Creating new records
n = Book.new( :title =&gt; 'My Stupid Cat', :author_id =&gt; 23 )

# Finder mehods
a = Author.find(2)    # Jane Austen
b = Book.find(4)      # "Kiki vs the sunglasses tyrants"

# Attribute methods
first_name = a.first_name       # Get an attribute
b.title    = 'Of mice and Zen'  # Set an attribute

# Saving or destroying an object
n.save     # Writes new row in database
n.destroy  # Removes row

# Misc
b.valid?
b.changed?      # True if modified in memory
n.new_record?   # Returns true until saved
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="models6">
    <h2>Querying</h2>
    <pre class="transp"><code class="ruby" data-trim>
# Create querying objects with WHERE clauses
r1 = Author.where(:last_name =&gt; 'Das')  # does NOT query yet
r2 = r1.where(:first_name =&gt; 'Beyonc&eacute;')

# SELECT `authors`.* FROM `authors` WHERE `authors`.`last_name` = 'Das'
a_list = r1.to_a  # Array of Author objects

# SELECT  `authors`.* FROM `authors`
#   WHERE `authors`.`last_name` = 'Das'
#   ORDER BY `authors`.`id` ASC LIMIT 1
a1 = r1.first

# SELECT  `authors`.* FROM `authors`
#   WHERE `authors`.`last_name` = 'Das'
#     AND `authors`.`first_name` = 'Beyonc&eacute;'
#   ORDER BY `authors`.`id` DESC LIMIT 1
a2 = r2.last  # returns nil in this case

# SELECT COUNT(*) FROM `authors` WHERE `authors`.`last_name` = 'Das'
das_count = r1.count
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="models7">
    <h2>Relations</h2>
    <center>
    <div class="cell">
      <small><em>app/models/author.rb</em></small>
      <pre class="transp"><code class="ruby" data-trim>
class Author &lt; ApplicationRecord
  has_many :books
end
      </code></pre>
    </div>
    <div class="cell">
    &nbsp; &nbsp; &nbsp;
    </div>
    <div class="cell">
      <small><em>app/models/book.rb</em></small>
      <pre class="transp"><code class="ruby" data-trim>
class Book &lt; ApplicationRecord
  belongs_to :author
end
      </code></pre>
    </div>
    </center>
  </section>

<!-- ****************************** -->

  <section id="models8">
    <h2>Relation methods</h2>
    <pre class="transp"><code class="ruby" data-trim>
a=Author.where(:last_name =&gt; 'Das').first
#  Author Load (0.9ms)  SELECT  `authors`.* FROM `authors` WHERE
#     `authors`.`last_name` = 'Das' ORDER BY `authors`.`id` ASC LIMIT 1
a.books.to_a
#  Book Load (0.4ms)  SELECT `books`.* FROM `books` WHERE `books`.`author_id` = 3
' =&gt; [
   #&lt;Book id: 3, title: "Some sunglasses for Kiki", author_id: 3 ... &gt;,
   #&lt;Book id: 4, title: "Kiki vs the sunglasses tyrants", author_id: 3 ... &gt;,
   #&lt;Book id: 5, title: "The sunglasses of God", author_id: 3 ... &gt;
  ] '
b=Book.last
#  Book Load (1.2ms)  SELECT  `books`.* FROM `books` ORDER BY `books`.`id` DESC LIMIT 1
b.author
#  Author Load (0.4ms)  SELECT  `authors`.* FROM `authors` WHERE `authors`.`id` = 3 LIMIT 1
' =&gt; #&lt;Author id: 3, first_name: "Samir", last_name: "Das"&gt; '
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="models9">
    <h2>Validations and callbacks</h2>
    <img src="images/rails4_ar_callbacks.png">
    <small><small>
    From <strong>Agile Web Development with Rails 4</strong>,
    S. Ruby, D. Thomas, D. H. Hansson, 2014
    </small></small>
  </section>

<!-- ****************************** -->

  <section id="models10">
    <h2>Validations and callbacks</h2>
    <center>
    <div class="cell">
      <small><em>app/models/book.rb</em></small>
      <pre class="transp"><code class="ruby" data-trim>
class Book &lt; ApplicationRecord
  belongs_to :author
  validate_presence_of :published_at

  validates :last_name_has_uppercase?

  after_create :new_book_added

  def last_name_has_uppercase?
    self.last_name =~ /^[A-Z]/
  end

  def new_book_added
    # do something with self only when new book created
  end
end
      </code></pre>
    </div>
    </center>
  </section>

<!-- ****************************** -->

  <section id="models11">
    <h2>Single Table Inheritance</h2>
    <center>
    <div class="cell">
      <small><em>app/models/book.rb</em></small>
      <pre class="transp"><code class="ruby" data-trim>
class Book &lt; ApplicationRecord
end
      </code></pre>
    </div>
    <div class="cell">
    &nbsp; &nbsp; &nbsp;
    </div>
    <div class="cell">
      <small><em>app/models/novel.rb</em></small>
      <pre class="transp"><code class="ruby" data-trim>
class Novel &lt; Book
end
      </code></pre>
    </div>
    <div class="cell">
    &nbsp; &nbsp; &nbsp;
    </div>
    <div class="cell">
      <small><em>app/models/biography.rb</em></small>
      <pre class="transp"><code class="ruby" data-trim>
class Biography &lt; Book
end
      </code></pre>
    </div>
    </center>
    <pre data-trim>
mysql&gt; select * from books;
+----+--------------------------------------------+-----------+
| id | type      | title                          | author_id |
+----+--------------------------------------------+-----------+
|  1 | Book      | How to cheat at origami        |         1 |
|  2 | Biography | Pride And Potatoes             |         2 |
|  3 | Novel     | Some sunglasses for Kiki       |         3 |
|  4 | Novel     | Kiki vs the sunglasses tyrants |         3 |
|  5 | Novel     | The sunglasses of God          |         3 |
+----+--------------------------------------------+-----------+
    </pre>
  </section>

<!-- ****************************** -->

  <section id="models12">
    <h2>Migrations</h2>
    <ul>
      <li>Small Ruby programs encode changes</li>
      <li>No need to issue SQL statements</li>
      <li>The DB is aware of its migration version number</li>
      <li>Migrations can be applied and rolled back</li>
      <li>Migrations can change data, not just schema</li>
      <li>This is part of a framework for initializing and seeding the DB too</li>
    </ul>
    <p>
    <pre class="transp"><code class="ruby" data-trim>
class AddSenderIdToMessage &lt; ActiveRecord::Migration
  def self.up
    add_column :messages, :sender_id, :integer
  end

  def self.down
    remove_column :messages, :sender_id
  end
end
    </code></pre>
    <small><em>20120530164358_add_sender_id_to_message.rb</em></small>
  </section>

</section>

<!-- ############################## -->
<!-- ############################## -->
<!-- ############################## -->

<section>

  <section id="controllers1">
    <h1>Rails</h1>
    <h2>Controllers</h2>
  </section>

<!-- ****************************** -->

  <section id="controllers2">
    <h2>Controllers</h2>
    <pre class="transp"><code class="ruby" data-trim>
class BooksController &lt; ApplicationController
  def index             # GET /books
  end

  def show              # GET /books/2
    id = params[:id]
  end

  def create            # POST /books
  end

  def destroy           # DELETE /book/id
    id = params[:id]
  end

  def update            # PUT /book/id
    id = params[:id]
  end
end
    </code></pre>
    <small><em>app/controllers/books_controller.rb</em></small>
  </section>

<!-- ****************************** -->

  <section id="controllers3">
    <h2>Routing</h2>
    <pre class="transp"><code class="ruby" data-trim>
Rails.application.routes.draw do

  # Routes built manually
  match "/books"     =&gt; "books#index"
  match "/books/:id" =&gt; "books#show"  # stores id in params[:id]
  match "/books"     =&gt; "books#create", :via =&gt; :post
  # etc

  # This creates about 7 standard CRUD routes for books
  resources :books

end
    </code></pre>
    <small><em>config/routes.rb</em></small>
  </section>

<!-- ****************************** -->

  <section id="controllers4">
    <h2>Instance variables for views</h2>
Within a controller method (or '<em>action</em>'),<br>
instance variables will be available in the view code.
    <pre class="transp"><code class="ruby" data-trim>
class BooksController &lt; ApplicationController
  def show              # GET /books/2

    # Basic, common business logic
    id = params[:id]
    @book = Book.find(id) # This can be used in the view code.

    # Rendering control, redirections, etc etc
    render :action =&gt; :show  # 'app/views/show.*' based on HTTP request
  end
end
    </code></pre>
    <small><em>app/controllers/books_controller.rb</em></small>
  </section>

</section>

<!-- ############################## -->
<!-- ############################## -->
<!-- ############################## -->

<section>

  <section id="views1">
    <h1>Rails</h1>
    <h2>Views</h2>
  </section>

<!-- ****************************** -->

  <section id="views2">
    <h2>Views</h2>
    <pre class="transp"><code class="erb" data-trim>
&lt;html&gt;
&lt;head&gt; &lt;/head&gt; &lt;!-- Not normally in view code! --&gt;
&lt;body&gt;
Book title: &lt;%= @book.title %&gt;
Book author: &lt;%= @book.author.first_name %&gt; &lt;%= @book.author.last_name %&gt;
&lt;/body&gt;
&lt;/html&gt;
    </code></pre>
    <small><em>app/views/books/show.html.erb</em></small>
    <p>
    <small><i>Note:</i> normally, view files render partial content inside other common view templates.</small>
  </section>

<!-- ****************************** -->

  <section id="views3">
    <h2>View files for model <em>User</em> in CBRAIN</h2>
    <pre data-trim>
&gt; ls -l users
-rw-r--r--  1 prioux  staff  5755 Dec 12  2017 _users_table.html.erb
-rw-r--r--  1 prioux  staff  1949 Feb 27  2017 change_password.html.erb
-rw-r--r--  1 prioux  staff   886 May 13  2015 index.html.erb
-rw-r--r--  1 prioux  staff   928 May 13  2015 index.js.erb
-rw-r--r--  1 prioux  staff  3709 Jan 11 12:09 new.html.erb
-rw-r--r--  1 prioux  staff  1371 Feb 27  2017 request_password.html.erb
-rw-r--r--  1 prioux  staff  9499 Jun 20 10:11 show.html.erb
    </pre>
  </section>

</section>

<!-- ############################## -->
<!-- ############################## -->
<!-- ############################## -->

<section>

  <section id="cbrain1">
    <h1>CBRAIN</h1>
    <h2>A web-based computing platform
    with support for supercomputing processing
    and data management abstraction and oh
    my god I am out of room for all the buzzwords
    </h2>
  </section>

<!-- ****************************** -->

  <section id="cbrain2">
    <h2>Initial goals (2008)</h2>
    <small>Reza Adalat, Marc-&Eacute;tienne Rousseau, Pierre Rioux, Tarek Sherif</small>
    <ul>
      <li>Use a <strong>web interface</strong>...</li>
      <li>... to manage <strong>data</strong>...</li>
      <li>... and <strong>process them</strong> with <strong>neuroscience tools</strong></li>
    </ul>
    <p>
  </section>

<!-- ****************************** -->

  <section id="cbrain3">
    <h2>Technologies used</h2>
    <table>
      <tr>
        <td><strong>web interface</strong></td><td>Ruby On Rails</td>
      </tr>
      <tr>
        <td><strong>data</strong></td><td><em>Userfile</em> and <em>DataProvider</em> models</td>
      </tr>
      <tr>
        <td><strong>processing</strong></td><td><em>CbrainTask</em> model</td>
      </tr>
      <tr>
        <td><strong>neuroscience tools</strong></td><td><em>Tool</em> and <em>ToolConfig</em> models</td>
      </tr>
    </table>
  </section>

<!-- ****************************** -->

  <section id="cbrain4">
    <h2>Two Rails apps!</h2>
    The overall architecture has two Rails apps:
    <p>
    <ul>
      <li><em>BrainPortal</em>: provides the graphical web interface</li>
      <li><em>Bourreau</em>: interacts with a supercomputer to process stuff</li>
      <li>There can be several <em>Bourreaux</em>, but a single <em>BrainPortal</em></li>
      <li>All connect to the same <strong>Rails database</strong></li>
    </ul>
    <p>
    <img src="images/simple_cb.png">
  </section>

<!-- ****************************** -->

  <section id="cbrain5">
    <h2>The Great Anti-Neuro Of 2014</h2>
    That year, everything that was specific to neuroscience<br>
    was <strong>removed</strong> from the CBRAIN codebase.
    <p>
    All the neuroscience code was partitioned into<br>
   <strong>distinct, separate</strong> GIT repos.
    <p>
    CBRAIN was extended such that when these other GIT repos are<br>
    extracted within a specific <em>cbrain_plugins</em> subdirectory,<br>
    they integrate automatically.
    <p>
    This became CBRAIN's <strong>plugins</strong> support, and so<br>
    CBRAIN is now a generic processing platform.
  </section>

<!-- ****************************** -->

  <section id="cbrain6">
    <h2>Two simple models<h2>
    <h3><em>User</em></h3>
    Just the information about a user: name, email etc.
    <p>
    <h3><em>Group</em></h3>
    Basically, a group is a set of users.
    <p>
    <ul>
      <li>Groups are shown in the interface as <strong>Projects</strong></li>
      <li>Each user initially gets a private group with only them in it</li>
      <li>Users can create their own groups (projects)</li>
      <li>Users can invite other users to join their groups (collaboration)</li>
      <li>Groups are assigned to <strong>all</strong> resources</li>
      <li>System admins can create projects to limit access to resources</li>
    </ul>
  </section>

</section>

<!-- ############################## -->
<!-- ############################## -->
<!-- ############################## -->

<section>

  <section id="data1">
    <h1>CBRAIN</h1>
    <h2>User data</h3>
  </section>

<!-- ****************************** -->

  <section id="data2">
    <h2>Managing files</h2>
    Some design decisions for files:
    <p>
    <ul>
      <li>No paths in database</li>
      <li>Just a basename (e.g. <em>abc.txt</em>)</li>
      <li>The Rails top model is named <em>Userfile</em></li>
      <li>It is an abstract class</li>
      <li>There are many <strong>types</strong> implemented by subclasses</li>
      <li>So we use Rails Single Table Inheritance</li>
    </ul>
    <p>
    <center>
    <div class="cell">
    <pre data-trim class="compact">
# Table: userfiles
+----+--------------------------------------------------+
| id | type            | name                           |
+----+--------------------------------------------------+
| 12 | SingleFile      | nihpd3.tar.gz                  |
| 34 | TextFile        | abc.txt                        |
| 55 | FileCollection  | dicom_files                    |
| 98 | DicomCollection | more_dicoms                    |
+----+--------------------------------------------------+</pre>
    <br>
    <small>SQL table (excerpt)</small>
    </div>
    </center>
  </section>

<!-- ****************************** -->

  <section id="data3">
    <h2>Userfile subclasses</h2>
    <img src="images/userfiles_classes.png">
    <small>File types can only be reassigned within the same subbranch<br>
    (<em>SingleFile</em>, <strong>FileCollection</strong>)</small>
  </section>

<!-- ****************************** -->

  <section id="data4">
    <h2>DataProviders</h2>
    So where ARE those files?
    <p>
    <ul>
      <li>Each file is associated with a single <em>DataProvider</em></li>
      <li>The provider's role is to know where the file's content is stored</li>
      <li>The provider has a generic API for transfering content in/out</li>
      <li>A provider is NOT a posix file API</li>
      <li>The provider handles remote connections as needed</li>
      <li>A CBRAIN system can have many DataProviders</li>
    </ul>
  </section>

<!-- ****************************** -->

  <section id="data5">
    <h2>DataProvider types</h2>
    Provider <em>types</em> differ in:
    <p>
    <ul>
      <li>How they structure their filesystem</li>
      <li>How they connect to a remote host (if any)</li>
      <li>What types of files they support</li>
      <li>Whether or not two users can each have a file with the same name on it</li>
      <li>Whether or not a file's owner can be re-assigned</li>
    </ul>
  </section>

<!-- ****************************** -->

  <section id="data6">
    <h2>Standard vs Browsable</h2>
    <em>Standard</em> DataProviders are for storage<br>
    of files <strong>entirely managed by CBRAIN itself</strong>:
    <p>
    <ul>
      <li>The file structure can be non-obvious</li>
      <li>The content itself might not be physical files</li>
      <li>CBRAIN doesn't expect any changes that it didn't do itself</li>
    </ul>
    <p>
    <em>Browsable</em> DataProviders are for more convenient data-exchange:
    <ul>
      <li>The files are in normal directories</li>
      <li>The structure is usually flat</li>
      <li>External processes can add or remove files</li>
      <li>When new files are added, they can be <strong>registered</strong> (i.e. a DB entry is added)</li>
    </ul>
  </section>

<!-- ****************************** -->

  <section id="data7">
    <img src="images/dp_subclasses.png">
  </section>

<!-- ****************************** -->

  <section id="data8">
    <h2>Userfiles and their DPs</h2>
    <p>
    <center>
    <div class="cell">
    <pre data-trim class="compact">
# Table: userfiles
+----+--------------------------------------------------+-------------------+
| id | type            | name                           | data_provider_id  |
+----+--------------------------------------------------+-------------------+
| 12 | SingleFile      | nihpd3.tar.gz                  | 2                 |
| 34 | TextFile        | abc.txt                        | 3                 |
| 55 | FileCollection  | dicom_files                    | 3                 |
| 98 | DicomCollection | more_dicoms                    | 3                 |
+----+--------------------------------------------------+-------------------+
</pre>
    <p>
    <pre data-trim class="compact">
# Table: data_providers
+----+--------------------------------------------------+-------------------+
| id | type                            | name           | config_stuff_cols |
+----+--------------------------------------------------+-------------------+
| 2  | EnCbrainSmartDataProvider       | MainStore      | paths, hosts,     |
| 3  | IncomingVaultSmartDataProvider  | SFTP-1         | credentials etc   |
+----+--------------------------------------------------+-------------------+
</pre>
    <br>
    <small>Two SQL tables (excerpt)</small>
    </div>
    </center>
  </section>

<!-- ****************************** -->

  <section id="data9">
    <h2>File manager example</h2>
    <img src="images/file_manager1.png">
  </section>

<!-- ****************************** -->

  <section id="data10">
    <h2>Caching</h2>
    <ul>
      <li>Each Rails application has a data cache</li>
      <li>A programmer always work with the content in that cache</li>
      <li>New files:
        <ul>
          <li>create database entry</li>
          <li>create data in cache (mkdir, open/write etc)</li>
          <li><em>sync_to_provider()</em></li>
        </ul>
      </li>
      <li>Existing files:
        <ul>
          <li>find database entry</li>
          <li><em>sync_to_cache()</em></li>
          <li>use data in cache (or modify it)</li>
          <li><em>sync_to_provider()</em> (if modified)</li>
        </ul>
      </li>
    </ul>
  </section>

<!-- ****************************** -->

  <section id="data11">
    <h2>So many caches!</h2>
    <img src="images/full_cb.png" class="resize80">
  </section>

<!-- ****************************** -->

  <section id="data12">
    <h2>Coding with DPs</h2>
    <img src="images/dp_abstract.png">
    <small><i>Note:</i> for convenience, all <em>DataProvider</em> API methods are provided directly on <em>Userfile</em></small>
  </section>

<!-- ****************************** -->

  <section id="data13">
    <h2>The <em>SyncStatus</em> framework</h2>
    All data transfer operations are tracked using the <em>SyncStatus</em> model.
    <p>
    At any one time:
    <ul>
      <li><strong>Many</strong> Rails app can <strong>download</strong> the same file's content</li>
      <li><strong>Only one</strong> Rails app can <strong>upload</strong> the file's content</li>
    </ul>
    <p>Also:
    <ul>
      <li>Timestamps track how long ago synchronization happened</li>
      <li>Caches have expiry dates</li>
      <li>API calls allow a programmer to mark cache as new/obsolete etc</li>
      <li>The <em>SyncStatus</em> API itself is low-level and rarely invoked directly</li>
      <li>Users can manually clean the caches (e.g. for sensitive data)</li>
    </ul>
  </section>

</section>

<!-- ############################## -->
<!-- ############################## -->
<!-- ############################## -->

<section>

  <section id="viewers1">
    <h1>CBRAIN</h1>
    <h2>Viewing Data In Browser</h2>
  </section>

<!-- ****************************** -->

  <section id="viewers2">
    <h2>Userfile Viewers</h2>
    <img src="images/cblist_classes.png" class="resize80">
  </section>

<!-- ****************************** -->

  <section id="viewers3">
    <h2>Viewer web content area</h2>
    <img src="images/userfile_views/userfile_view_blank.png">
    <small>Top region is database content, bottom region is file type, plugin content</small>
  </section>

<!-- ****************************** -->

  <section id="viewers4">
    <h2><em>CbrainFileList</em> as TextFile</h2>
    <img src="images/userfile_views/userfile_view_txt.png">
  </section>

<!-- ****************************** -->

  <section id="viewers5">
    <h2><em>CbrainFileList</em> as CsvFile</h2>
    <img src="images/userfile_views/userfile_view_csv.png">
  </section>

<!-- ****************************** -->

  <section id="viewers6">
    <h2><em>CbrainFileList</em> as itself</h2>
    <img src="images/userfile_views/userfile_view_cblist.png">
  </section>

<!-- ****************************** -->

  <section id="viewers7">
    <h2>Userfile Viewer Code</h2>

    <pre class="transp"><code class="ruby" data-trim>
# CBRAIN Ruby model for MP3 audio files.
class Mp3AudioFile < AudioFile # AudioFile is a SingleFile

  has_viewer :name => 'MP3 Audio', :partial =&gt; :html5_mp3_audio, :if =&gt; :is_locally_synced?

  def self.pretty_type
    "MP3 Audio File"
  end
end
    </code></pre>
    <small><strong>cbrain_plugins/cbrain-plugins-base/userfiles/</strong><em>mp3_audio_file/mp3_audio_file.rb</em></small>
    <p>
    <pre class="transp"><code class="erb" data-trim>
&lt;audio controls="controls" preload="none"&gt;
  &lt;source src="&lt;%= content_userfile_path(@userfile) %&gt;" type="audio/mp3" /&gt;
  MP3 audio not supported in this browser.
&lt;/audio&gt;
    </code></pre>
    <small><strong>cbrain_plugins/cbrain-plugins-base/userfiles/</strong><em>mp3_audio_file/views/_mp3_audio_file.html.erb</em></small>
  </section>

</section>

<!-- ############################## -->
<!-- ############################## -->
<!-- ############################## -->

<section>

  <section id="tasks1">
    <h1>CBRAIN</h1>
    <h2>Processing files</h2>
  </section>

<!-- ****************************** -->

  <section id="tasks2">
    <h2>How supercomputers work</h2>
    <ul>
      <li>They expect a <strong>script</strong> to be <strong>submitted</strong></li>
      <li>Each supercomputer has its own submission system</li>
      <li>Each supercomputer has its own filesystem layout</li>
      <li>You have to transfer your data in and out</li>
    </ul>
  </section>

<!-- ****************************** -->

  <section id="tasks3">
    <h2>CBRAIN's goal for users</h2>
    <ul>
      <li>No need to learn how the supercomputer works</li>
      <li>Just select files in CBRAIN, select a tool, a click <strong>go!</strong></li>
      <li>This can result in thousands of tasks quickly submitted</li>
    </ul>
  </section>

<!-- ****************************** -->

  <section id="tasks4">
    <h2>The <em>CbrainTask</em> model</h2>
    <pre data-trim class="compact">
# Table: cbrain_tasks
+----+--------------------------------------------------+---------+------------+
| id | type                            | bourreau_id    | user_id | params     |
+----+--------------------------------------------------+---------+------------+
| 38 | Civet                           | 3              | 5       | (yaml)     |
| 79 | Minc2Niftii                     | 4              | 3       | (yaml)     |
| 88 | ReconAll                        | 4              | 3       | (yaml)     |
+----+--------------------------------------------------+---------+------------+
</pre>
    <small>SQL table (excerpt)</small>
  </section>

<!-- ****************************** -->

  <section id="tasks5">
    <h2>Task programmer's job</h2>
    A basic CbrainTask requires a programmer to implement these files:
    <p>
    <table>
      <tr>
        <th>File path in plugin</th>
        <th>Role</th>
       </tr>
      <tr>
        <td>.../portal/taskname.rb</td>
        <td>Portal-side code</td>
       </tr>
      <tr>
        <td>.../views/_task_params.html.erb</td>
        <td>Input form for task params</td>
      </tr>
      <tr>
        <td>.../views/_show_params.html.erb</td>
        <td>View code for task info</td>
      </tr>
      <tr>
        <td>.../bourreau/taskname.rb</td>
        <td>Bourreau-side code</td>
      </tr>
    </table>
    <p>
    <small><i>Note:</i> these are the core files only, there are many more</small>
  </section>

<!-- ****************************** -->

  <section id="tasks6">
    <h2>Portal-side code</h2>
    <h4>Its role:</h4>
    <ul>
      <li>Validate the initial files selected by user</li>
      <li>Validate the parameters supplied by the form</li>
      <li>Return one (or several) CbrainTask objects, pre-filled</li>
      <li>The CbrainTask objects do not even have to all be of the same class as the Ruby Class!</li>
    </ul>
  </section>

<!-- ****************************** -->

  <section id="tasks7">
    <h2>Minimal Portal code</h2>
    <pre class="transp"><code class="ruby" data-trim>
class CbrainTask::Stupid &lt; PortalTask

  def before_form # verify stuff before rendering the form
    ids = params[:interface_userfile_ids]  # array of ids
    raise "Need at least one file selected" if ids.size == 0
    "" # Means all is OK
  end

  def after_form # verify or do stuff after form submitted
    "" # I could do something here too
  end

  def final_task_list # framework expects an array of task objects to be saved
    [ self ] # This is actually the default behavior in PortalTask
  end

end
    </code></pre>
    <small><strong>cbrain_plugins/cbrain-plugins-base/cbrain_task/</strong><em>stupid/portal/stupid.rb</em></small><br>
    <small><i>Note:</i> many features not shown: default params values, pretty param names, etc, etc</small>
  </section>

<!-- ****************************** -->

  <section id="tasks8">
    <h2>Parameter forms</h2>
    <img src="images/launch_task_blank.png" class="resize80">
  </section>

<!-- ****************************** -->

  <section id="tasks9">
    <h2>Sample params form</h2>
    <pre class="transp"><code class="erb" data-trim>
This task has &lt;%= (params[:interface_userfile_ids] || []).size %&gt; files in its input list.
&lt;p&gt;
Name for planet: &lt;%= form.params_text_field :name_of_planet %&gt;&lt;br&gt;
Destroy it?      &lt;%= form.params_check_box  :destroy_planet %&gt;&lt;br&gt;
    </code></pre>
    <small><strong>cbrain_plugins/cbrain-plugins-base/cbrain_task/</strong><em>stupid/views/_show_params.html.erb</em></small>
  </section>

<!-- ****************************** -->

  <section id="tasks10">
    <h2>Params form appearance </h2>
    <img src="images/launch_task_planet.png" class="resize80">
  </section>

<!-- ****************************** -->

  <section id="tasks11">
    <h2>Generated HTML form code</h2>
    <pre class="transp"><code class="html" data-trim>
This task has 2 files in its input list.
&lt;p&gt;
Name for planet: &lt;input name="cbrain_task[params][name_of_planet]"
                          id="cbrain_task_BRA_params_KET__BRA_name_of_planet_KET_"
                       value=""
                        type="text"
                 &gt;
&lt;br&gt;
Destroy it?      &lt;input name="cbrain_task[params][destroy_planet]"
                       value="0"
                        type="hidden"
                 &gt;
                 &lt;input name="cbrain_task[params][destroy_planet]"
                          id="cbrain_task_BRA_params_KET__BRA_destroy_planet_KET_"
                       value="1"
                        type="checkbox"
                 &gt;
&lt;br&gt;
    </code></pre>
    <p>
    <small><i>Note:</i> manually reformatted for easier inspection</small>
  </section>

<!-- ****************************** -->

  <section id="tasks12">
    <h2>CbrainTask object content</h2>
    <pre class="transp"><code class="ruby" data-trim>
class TasksController &lt; ApplicationController

  # Rails will send all the HTML form inputs all
  # structured nicely, e.g.
  #
  #   params = { :cbrain_tasks =&gt; { :description =&gt; 'a test', # a normal attribute
  #                                 :params =&gt; { :planet_name =&gt; 'Mars'... },
  #                                 # other attribute here
  #                               } }
  def create # POST /tasks
    post_params = params[:cbrain_tasks] # Provided by Rails
    @task = CbrainTask.new(post_params) # Store everything in a new object

    #  @task.description          == 'a test'
    #  @task.params[:planet_name] == 'Mars' etc

    # Invoke task callback methods here for @task
    # Create entries in DB with @task, etc
  end
end
    </code></pre>
    <small><em>app/controllers/tasks_controller.rb</em></small>
  </section>

<!-- ****************************** -->

  <section id="tasks13">
    <h2>The (almost) full diagram</h2>
    <a target="_blank" href="images/task_create.png"><img src="images/task_create.png" class="resize40"></a>
    <p>
    <small><i>Note:</i> Click image to open it in a new tab</small>
  </section>

<!-- ****************************** -->

  <section id="tasks14">
    <h2>Bourreau-side code</h2>
    <h4>Its role while setting up:</h4>
    <ul>
      <li>Synchronize the input files locally</li>
      <li>Build and return a bash script</li>
    </ul>
    <p>
    <h4>Its role after a job has completed:</h4>
    <ul>
      <li>Verify that the job seems to have completed properly</li>
      <li>Take the result files, create new Userfiles, and upload to the DP</li>
    </ul>
  </section>

<!-- ****************************** -->

  <section id="tasks15">
    <h2>Skeleton Bourreau code</h2>
    <pre class="transp"><code class="ruby" data-trim>
class CbrainTask::Stupid &lt; ClusterTask

  def setup
    # Set up all that's needed to run the process
  end

  def cluster_commands
    # Return a bash script
  end

  def save_results
    # Verify that processing is OK;
    # if so, save the results as new CBRAIN files
  end

end
    </code></pre>
    <small><strong>cbrain_plugins/cbrain-plugins-base/cbrain_task/</strong><em>stupid/bourreau/stupid.rb</em></small><br>
  </section>

<!-- ****************************** -->

  <section id="tasks16">
    <h2>Execution context?</h2>
    The bourreau-side code can rely on many things<br>
    set up by the CBRAIN framework:
    <p>
    <ul>
      <li>A work directory for the task (cwd)</li>
      <li>Prerequisites are fulfilled (more on that later)</li>
      <li><em>$PATH</em> and bash <strong>modules</strong> etc... are all set up</li>
      <li>The local <strong>DataProvider cache</strong> is available for file input/output</li>
    </ul>
    <p>
    The task programmer does not have to set any of these things up.
  </section>

<!-- ****************************** -->

  <section id="tasks17">
    <h2>Bourreau: Setup</h2>
    <pre class="transp"><code class="ruby" data-trim>
def setup
  my_params = self.params # a hash with arbitrary content, usually the scientific parameters

  # Extract info about our file (we only use the first in this demo code)
  file_id  = params[:interface_userfile_ids].first # first of an array of IDs
  f        = Userfile.find(file_id)

  # We need to make sure our input data is ready locally
  f.sync_to_cache
  # I could also use f.cache_full_path here to refer to sync'ed content

  true # all good!
end
    </code></pre>
    <small>Excerpt: <strong>cbrain_plugins/cbrain-plugins-base/cbrain_task/</strong><em>stupid/bourreau/stupid.rb</em></small><br>
  </section>

<!-- ****************************** -->

  <section id="tasks18">
    <h2>Bourreau: Commands</h2>
    <pre class="transp"><code class="ruby" data-trim>
def cluster_commands
  my_params = self.params

  # Extract info about what to do
  pname    = params[:planet_name]
  killit   = params[:destroy_planet] == '1'
  file_id  = params[:interface_userfile_ids].first # first of an array of IDs
  fpath    = Userfile.find(file_id).cache_full_path

  # Build the script or command to run on the supercomputer
  command   = "planet_manager -p #{pname} -f #{fpath}" # not shown: helpers to avoid injection
  command  += " -k YES" if killit
  return command
end
    </code></pre>
    <small>Excerpt: <strong>cbrain_plugins/cbrain-plugins-base/cbrain_task/</strong><em>stupid/bourreau/stupid.rb</em></small><br>
    <p>
    This builds the simple bash script
<pre data-trim>
planet_manager -p pluto -f /path/to/userfile/cache
</pre>
or, if the checkbox <em>destroy_planet</em> was set,
<pre data-trim>
planet_manager -p pluto -f /path/to/userfile/cache -k YES
</pre>
  </section>

<!-- ****************************** -->

  <section id="tasks19">
    <h2>Bourreau: Final Checks</h2>
    <pre class="transp"><code class="ruby" data-trim>
def save_results
  # Check that the task worked fine
  return false unless File.exists? "report.txt"

  new_cb_file = Textfile.new(:name =&gt; "PlanetReport", more_other_args_here)
  new_cb_file.save!
  # Next line: copies the content to the cache, then autosync to DataProvider
  new_cb_file.cache_copy_from_localfile("report.txt")
  true
end
    </code></pre>
    <small>Excerpt: <strong>cbrain_plugins/cbrain-plugins-base/cbrain_task/</strong><em>stupid/bourreau/stupid.rb</em></small><br>
  </section>

<!-- ****************************** -->

  <section id="tasks20">
    <h2>Task Status States</h2>
    <ul>
      <li>Tasks have states, a string</li>
      <li>States are assigned and modified by CBRAIN</li>
      <li>Some changes are made by the portal, some by the Bourreau</li>
      <li>Some changes are active, other passive (observation on supercomputer)</li>
    <ul>
  </section>

<!-- ****************************** -->

  <section id="tasks21">
    <h2>Task State Diagram</h2>
    <img src="images/task_states.png">
    <p>
    In red: states where the Ruby code of previous slides is run.
    <p>
    <small><i>Note:</i> Full explanations on the <A href="https://github.com/aces/cbrain/wiki/CbrainTask-Programmer-Guide#iii-standard-life-cycle-diagram">CBRAIN GitHub Wiki</A></small>
  </section>

<!-- ****************************** -->

  <section id="tasks22">
    <h2>Scir</h2>
    "<em>S</em>imple <em>C</em>luster <em>I</em>nterface in <em>R</em>uby"
    <p>
    <ul>
      <li>It's a set of Ruby classes and subclasses</li>
      <li>Written from scratch when <em>DRMAA</em> failed miserably</li>
      <li>It knows how to interact with different supercomputers:<p>
        <ol>
          <li>Submit bash scripts</li>
          <li>Query supercomputer status</li>
          <li>Query job status</li>
          <li>Cancel, hold, suspend jobs etc</li>
        </ol>
        <p>
      </li>
      <li>Supports: PBS/Torque, MOAB, SLURM, SGE, SharcNet, Amazon EC2, LSF, Cobalt, and plain Unix jobs</li>
    </ul>
  </section>

<!-- ****************************** -->
  <section id="tasks23">
    <img src="images/scir.png">
  </section>

<!-- ****************************** -->

  <section id="tasks24">
    <h2>Task Dependencies</h2>
    Tasks are generally independent of each other.
    <p>
    But there is an API to control their progression<br>
    based on the states of other tasks.
    <p>
    There are two <strong>stop points</strong> in the state diagram:
    <p>
    <ul>
      <li>At the state <i>Setting Up</i></li>
      <li>At the state <i>Post Processing</i></li>
    </ul>
    <p>
    A task can be prevented from entering these states until
    an arbitrary number of other tasks are in an arbitrary set of other states.
    <p>
    A task can even depend on another task being in a <i>Failed</i> state!
  </section>

<!-- ****************************** -->

  <section id="tasks25">
    <h2>Task Dependencies API</h2>
    <img src="images/task_deps.png" class="resize80"><br>
    <pre class="transp"><code class="ruby" data-trim>
# Example of setting up the dependencies above
task2a    .add_prerequisites_for_setup(           task1,     "Queued"    )
task2b    .add_prerequisites_for_setup(           task1,     "Queued"    )
finaltask .add_prerequisites_for_post_processing( task2a,    "Completed" )
finaltask .add_prerequisites_for_post_processing( task2b,    "Completed" )
errortask .add_prerequisites_for_setup(           finaltask, "Failed"    )
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="tasks26">
    <h2>Sharing Work Directories</h2>
    By default each task gets its own <em>work directory</em>.
    <p>
    However, any group task or group of tasks can be configured
    with an option to share the work directory of another task.
    <p>
    This, of course, can only work if all the tasks<br>
    are launched on the same supercomputer.
    <pre class="transp"><code class="ruby" data-trim>
# Example of making sure task1, task2a and task2b all
# share the same work directory.
task2a.share_workdir_with( task1 )
task2b.share_workdir_with( task1 )
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="tasks27">
    <h2>Task Restartability</h2>
    Tasks that have succesfully <em>Completed</em> can be restarted.
    <p>
    <ul>
      <li>The attribute <em>run_number</em> is increased (it starts at 1)</li>
      <li>The restart can be triggered at <strong>three</strong> states in the task's lifecycle:
        <p>
        <ol>
          <li>At the <strong>setup</strong> stage</li>
          <li>At <strong>submission to the supercomputer</strong></li>
          <li>At the <strong>post processing</strong> stage</li>
        </ol>
        <p>
      </li>
    </ul>
  </section>

<!-- ****************************** -->

  <section id="tasks28">
    <h2>Task Error Recovery</h2>
    Supercomputers, network connections, file servers and<br>
    random number generators are all <strong>unreliable</strong>!
    <p>
    So tasks can fail at different stages for different reasons:
    <p>
    <ul>
      <li>System reasons (network, files, etc)</li>
      <li>Pipeline dependencies (other tasks states)</li>
      <li>Task-specific (bad parameters, bad input files etc)</li>
    </ul>
    <p>
    The CBRAIN interface allow users to <strong>retry</strong> tasks that have failed.
  </section>

<!-- ****************************** -->

  <section id="tasks29">
    <h2>About Restart and Recover</h2>
    For these two features, a task programmer<br>
    should <strong>provide some handler methods</strong>
    <p>
    <pre class="transp"><code class="ruby" data-trim>
class CbrainTask::Something &lt; ClusterTask
  # Restartability Methods
  def restart_at_setup
  def restart_at_cluster
  def restart_at_post_processing
  # Error Recoverability Methods
  def recover_from_setup_failure
  def recover_from_cluster_failure
  def recover_from_post_processing_failure
end
    </code></pre>
    <p>
    However, by following <strong>CBRAIN programming guidelines</strong>, a programmer
    can also avoid having to write these methods by making the other standard API methods
    <strong>restartable and recoverable naturally</strong>.
  </section>

<!-- ****************************** -->

  <section id="tasks30">
    <h2>Example: restarting at setup</h2>
    <div class="cell">
<h4>Standard Way</h4>
    <pre class="transp"><code class="ruby" data-trim>
class CbrainTask::Something &lt; ClusterTask

  def setup
    # symlink() raise an exception
    # if target exists!
    File.symlink cache_data, "my_input"
  end

  def restart_at_setup
    File.rm "my_input"
  end

end
    </code></pre>
    </div>

    <div class="cell">
    &nbsp; &nbsp; &nbsp;
    </div>

    <div class="cell">
<h4>Easy Way</h4>
    <pre class="transp"><code class="ruby" data-trim>
class CbrainTask::Something &lt; ClusterTask

  include RestartableTask # adds trivial restart_at_setup()

  def setup
    # safe_symlink() is a CBRAIN helper method
    safe_symlink cache_data, "my_input"
  end

end
    </code></pre>
    </div>
  </section>

<!-- ****************************** -->

  <section id="tasks31">
    <h2>Task States: Restarting</h2>
    <img src="images/task_states_restart.png">
    <p>
    In red: states where the Ruby code in handlers is run.
  </section>

<!-- ****************************** -->

  <section id="tasks32">
    <h2>Task States: Recovering</h2>
    <img src="images/task_states_recover.png">
    <p>
    In red: states where the Ruby code in handlers is run.
  </section>

<!-- ****************************** -->

  <section id="tasks33">
    <h2>Task Archiving, Relocation</h2>
    If a programmer strictly respects the<br>
    CBRAIN task programming guidelines:
    <p>
    <ul>
      <li>All files in the workdir will use relocatable symlinks</li>
      <li>No hardcoded full paths are present in the scripts</li>
    </ul>
    <p>
    In that case, a task's work directory can be <strong>archived</strong> (turned into a <em>.tar.gz</em>), moved about, and even restarted on <strong>another supercomputer</strong>!
  </section>

<!-- ****************************** -->

  <section id="tasks34">
    <h2>ToolConfigs</h2>
    When a task is launched, it is not only associated<br>
    to a supercomputer, but also to a set of<br>
    <em>ToolConfig objects</em> in the database.
    <p>
    <em>ToolConfigs</em> are created by the administrator<br>
    using the interface. They provide configuration information<br>
    for a <strong>version</strong> of a scientific tool on a specific supercomputer.
    <p>
    <ul>
      <li>Environment variables (PATHs, etc)</li>
      <li>Supercomputer parameters (nodes, cores, queue names)</li>
      <li>Arbitrary bash prologues (<em>source init.sh</em>, etc)</li>
    </ul>
    <p>
    This also means that the CBRAIN system itself, when deployed, is free of
    all the requirements of the tools it supports.
  </section>

<!-- ****************************** -->

  <section id="tasks35">
    <h2>Up to three ToolConfigs</h2>
    A task's configuration can be affected by up<br>
    to <strong>3</strong> (three, trois, drei, tres) <em>ToolConfigs</em>.
    <p>
    <ul>
      <li>A ToolConfig for <strong>any</strong> tasks types on the <strong>current</strong> supercomputer</li>
      <li>A ToolConfig the <strong>current</strong> task type on <strong>any</strong> supercomputers</li>
      <li>A ToolConfig the <strong>current</strong> task type on the <strong>current</strong> supercomputers</li>
    </ul>
    <p>
    The first two are optional, the last one is mandatory.<br>
    They are applied in this order.
    <p>
    The user usually selects the third one, and the first two<br>
    are applied automatically as necessary.
    <p>
    This gives the opportunity for the system administrator<br>
    to provide default configurations for task types, for supercomputers,<br>
    or more specifically for a task on a supercomputer.
  </section>

<!-- ****************************** -->

  <section id="tasks36">
    <h2>Automatic Parallelization</h2>
    <ul>
      <li>When a set of tasks is submitted, the admin can
          configure a ToolConfig attribute for parallelizing them.
      </li>
      <li>CBRAIN will launch the tasks normally, but after
          they are set up they will not be submitted.
      </li>
      <li>Instead, CBRAIN will create, configure and launch
          one (or several) <em>Parallelizer</em> tasks.
      </li>
      <li>Each Parallelizer will execute the scientific tasks of
          2, 3, 5, 10 etc of the original tasks.
      </li>
      <li>A Parallelizer is generic and doesn't need to know anything
          about the tasks it parallelize.
      </li>
      <li>Once a Parallelizer is finished, the original tasks just
          proceed to their post processing normally.
      </li>
    </ul>
  </section>

<!-- ****************************** -->

  <section id="tasks37">
    <h2>Boutiques</h2>
    <h4>A framework for deploying tools</h4>
    <div class="cell">
    <img src="https://boutiques.github.io/images/logo.png" class="resize10" style="float: left">
    A 2015 project by Tristan Glatard (now a PI at Concordia)
    while he worked with us here at CBRAIN.<br>
    The CBRAIN integration was written by
    R&eacute;mi Bernard and Tristan Aumentado-Armstrong.
    </div>
    <p>
    <ul>
      <li>All properties of a tool are described in a single JSON file</li>
      <li>CBRAIN reads that and builds everything:<br>
        <ol>
          <li>User interface (parameter form, help docs)</li>
          <li>Parameter validation code</li>
          <li>Bourreau-side code</li>
        </ol>
      <li>Boutiques comes with an interactive command-line tool to build such JSON descriptors</li>
      <li>Site: <a href="https://boutiques.github.io/">https://boutiques.github.io/</a></li>
    </ul>
  </section>

<!-- ****************************** -->

  <section id="tasks38">
    <h2>Boutiques Example</h2>
    <pre style="font-size: 40%"><code class="json" data-trim>
{
    "tool-version": "5.0.0",
    "name": "fsl_anat",
    "command-line": "fsl_anat [INPUT_FILE] [INPUT_DIR] [OUTPUT_DIR] [CLOBBER_FLAG] [WEAKBIAS_FLAG]
                     [NO_REORIENT_FLAG] [NO_CROP_FLAG] [NO_BIAS_FLAG] [NO_REGISTRATION_FLAG] [NO_NONLINEAR_REG_FLAG]
                     [NO_SEG_FLAG] [NO_SUBCORTSEG_FLAG] [NO_SEARCH_FLAG] [NO_CLEANUP_FLAG] [BIAS_FIELD_SMOOTHING_VAL]
                     [IMAGE_TYPE] [BET_F_PARAM]",
    "inputs": [
        {
            "command-line-flag": "-i",
            "description": "Input image file (for single-image use), such as .nii.gz. Either this or an input
                            dir (-d) must be specified, but not both.",
            "value-key": "[INPUT_FILE]",
            "type": "File",
            "list": false,
            "optional": true,
            "id": "infile",
            "name": "Input file"
        },
        {
            "command-line-flag": "-d",
            "description": "Existing input directory (.anat extension) where this script will be run in place.
                            Either this or an input file (-i) must be specified, but not both.",
            "value-key": "[INPUT_DIR]",
            "type": "File",
            "list": false,
(rest not shown...)
    </code></pre>
  </section>

<!-- ****************************** -->

  <section id="tasks39">
    <h2>Boutiques Limitations</h2>
    Although Boutiques makes integrating a new tools easier, it comes
    with limitations compared to CBRAIN's built-in capabilities:
    <p>
    <ul>
      <li>No support for mixed-types task sets</li>
      <li>No support for shared work directories</li>
      <li>Minimal support for restartability</li>
      <li>Minimal support for recoverability</li>
      <li>No support for CBRAIN 'refresh' in task forms</li>
      <li>No support for CBRAIN output file name generators</li>
      <li>No support for prerequisites and task dependencies</li>
    </ul>
  </section>

</section>

<!-- ############################## -->
<!-- ############################## -->
<!-- ############################## -->

<section>

  <section id="other1">
    <h1>CBRAIN</h1>
    <h2>Other CBRAIN Features</h2>
  </section>

<!-- ****************************** -->

  <section id="other2">
    <h2>Provenance</h2>
    All CBRAIN Ruby classes are aware of their own GIT revision number!
    <pre><code class="ruby" data-trim>
class SomeSuperSomething

  # All CBRAIN ruby code has a line like this:
  Revision_info = CbrainFileRevision[ __FILE__ ] # ignore the coloring error

end

# Create a new object
something = SomeSuperSomething.new

# Query the information from GIT
something.revision_info.basename      # returns "some_super_something.rb"
something.revision_info.author        # returns "Pierre Rioux"
something.revision_info.short_commit  # returns "8f112ca9"
something.revision_info.date          # returns "2018-08-01"
something.revision_info.time          # returns "19:45:33 -0500"
    </code></pre>

  </section>

<!-- ****************************** -->

  <section id="other3">
    <h2>MetaData</h2>
    We can add meta data to ANY ActiveRecord object in the DB.
    <pre><code class="ruby" data-trim>
user = User.where(:login =&gt; 'prioux').first
user.meta            # returns a handler for metadata of obj
user.meta[:age] = 76 # setter: sets value associated with :age
user.meta[:age]      # getter: returns value associated with :age

task = CbrainTask.first
task.meta[:xyz] = { :hello =&gt; 2, "goodbye" =&gt; "why?" } # save arbitrary data
    </code></pre>

    This is implemented in a <strong>single table</strong> that does <i>NOT</i> use
    any proper relational database joining, but is transparent
    using the Ruby API:

    <pre data-trim>
mysql&gt; select * from meta_data_store;
+----+-------+---------------+-------------------------------------------+
| id | ar_id | ar_table_name | key   | value                             |
+----+-------+---------------+-------------------------------------------+
| 47 |     3 | users         | "age" | "--- 76\n...\n"                   |
| 92 |  2344 | cbrain_tasks  | "xyz" | "---\n:hello: 2\ngoodbye: why?\n" |
+----+-------------------------------------------------------------------+
</pre>

  </section>

<!-- ****************************** -->

  <section id="other4">
    <h2>Logging</h2>
     We can log information to ANY ActiveRecord object in the DB.
    <pre><code class="ruby" data-trim>
user = User.where(:login =&gt; 'prioux').first
user.addlog("User complained about filesystem")

task = CbrainTask.first
task.addlog("Tried to transfer files, failed.")
    </code></pre>

    Exactly as for the meta data store, the logs are all saved in a
    single table the contains the table names along with the record ID.
    <p>
    Each log entry is timestamped and formatted.<br>
    E.g for the user above:
    <pre data-trim>
[2018-02-19 16:01:07 EST] NormalUser revision 4e779042 Pierre Rioux 2015-09-28
[2018-02-19 16:01:07 EST] create() UsersController rev. 46f29825 Account created by 'admin'
[2018-08-01 19:28:38 EDT] User complained about filesystem
</pre>
   The logging API has a rich set of methods for automatically
   recording the revision info of classes and code.
  </section>

</section>

<!-- ############################## -->
<!-- ############################## -->
<!-- ############################## -->

<section>

  <section id="skipped1">
    <h2>CBRAIN: Not described</h2>
    Many other CBRAIN features were not covered in this presentation.
    <p>
    <ul>
      <li>CbrainFormBuilder: helps programmers make forms for tasks</li>
      <li>Task subtasking system (Glatard, Quirion)</li>
      <li>Secure communication tunnels (SSH agents with locks etc)</li>
      <li>Support for Singularity and Docker containers in tasks</li>
      <li>Per-resource user licenses</li>
      <li>Rich console commands extensions for admin and devs</li>
      <li>Internal invitation system for collaborations</li>
      <li>Workers and sub-workers for task management</li>
      <li>Userfiles can be organized in trees (parents and childs)</li>
      <li>Tasks can be managed as batches</li>
      <li>And the neat Network Operation Center</li>
    </ul>
  </section>

</section>

<!-- ############################## -->
<!-- ############################## -->
<!-- ############################## -->

<section>

  <section id="end1">
    <h1>The End</h1>
    <h2 class="glow">Thank you</h2>

    <strong>The CBRAIN features described here were created by:</strong>
    <br>
    Tarek Sherif<br>
    Natacha Beck<br>
    R&eacute;mi Bernard<br>
    Tristan Aumentado-Armstrong<br>
    Tristan Glatard<br>
    Pierre Rioux
    <p>
    <strong>Project management:</strong>
    <br>
    Marc-&Eacute;tienne Rousseau<br>
    Shawn Brown
  </section>

</section>

    </div>
  </div>

<!-- ############################## -->
<!-- ############################## -->
<!-- ############################## -->

  <!-- Declares a filter to turn white into CBRAIN blue, #05A3D6 -->

  <svg height="0">
    <filter id="cbrainblue">
      <feColorMatrix values="0.0196 0.0    0.0    0 0
                             0.0    0.6392 0.0    0 0
                             0.0    0.0    0.8392 0 0
                             0      0      0      1 0"/>
    </filter>
  </svg>

  <!-- Main reveal.js setup -->

  <script src="lib/js/head.min.js"></script>
  <script src="js/reveal.js"></script>
  <script src="plugin/highlight/highlight.js"></script>
  <script>
    Reveal.initialize(
    { slideNumber: true, history: true }
    );
    hljs.initHighlightingOnLoad();
  </script>

  <!-- Styles -->

  <style>

    /* Headers */

    @keyframes glowing {
        0% { text-shadow: 0.0em 0.0em 0.0em #0cc; }
       25% { text-shadow: 0.0em 0.0em 0.2em #0dd; }
       50% { text-shadow: 0.0em 0.0em 0.4em #0ee; }
       75% { text-shadow: 0.0em 0.0em 0.2em #0dd; }
      100% { text-shadow: 0.0em 0.0em 0.0em #0cc; }
    }

    .reveal h1,
    .reveal h2,
    .reveal h3,
    .reveal h4,
    .reveal h5 {
      color: #ffffff;
      text-shadow: 0.0em 0.0em 0.2em #0cc;
    }

    /* Text styles: em, strong, b, i */

    .reveal .glow {
      animation: glowing 3555ms infinite;
    }

    .reveal em {
      color: yellow;
      font-style: normal; /* yes please! */
    }
    .reveal strong {
      color: #0ff;  /* funny, I'm using RGB with only three digits today */
    }
    .reveal b {
      color: #00f;
    }
    .reveal i {
      color: #f00;
      font-style: normal; /* yes please! */
    }

    /* Misc */

    .reveal section img {
      background: transparent;
      border: none;
      box-shadow: none;
    }
    .reveal section img.cbblue {
      filter: url(#cbrainblue);
    }
    .reveal pre {
      background: #033;
      /* padding: 0.2em 0.5em 0.3em 0.5em; */
      padding: 0;
      width: auto;
    }
    .reveal pre.compact {
      display: inline-block;
    }
    .reveal pre.large {
      font-size: 120%;
    }
    .reveal pre.medium {
      font-size: 100%;
    }
    .reveal pre.supersmall {
      font-size: 40%;
    }
    .reveal pre > code.nomaxheight {
      max-height: none;
    }
    .reveal .cell {
      display: table-cell;
    }
    .reveal th {
      color: #0aa;
    }
    .reveal .transp {
      background-color: transparent;
    }
    .reveal .resize80 { /* for pics */
      width: 80%;
      height: 80%;
    }
    .reveal .resize40 { /* for pics */
      width: 40%;
      height: 40%;
    }
    .reveal .resize10 { /* for pics */
      width: 10%;
      height: 10%;
    }

    .hljs-comment {  /* I don't like the default grey */
      color: #c9a929;
    }

  </style>
</body>

</html>
